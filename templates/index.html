<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WattMank - Solar Energy Solutions</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
        }
        .chat-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
        }
        .chat-box {
            transition: all 0.3s ease;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .chat-box:hover {
            transform: scale(1.01);
        }
        .upload-area {
            border: 2px dashed #4a5568;
            transition: all 0.3s ease;
            padding: 2rem;
        }
        .upload-area:hover {
            border-color: #4299e1;
            background-color: #f7fafc;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        .chat-messages {
            height: 60vh;
            overflow-y: auto;
            padding: 1rem;
        }
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Hero Section -->
    <div class="gradient-bg text-white min-h-screen">
        <nav class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="text-2xl font-bold">WattMank</div>
                <div class="space-x-6">
                    <a href="#about" class="hover:text-blue-300 transition">About</a>
                    <a href="#services" class="hover:text-blue-300 transition">Services</a>
                    <a href="#contact" class="hover:text-blue-300 transition">Contact</a>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-6 py-20">
            <div class="flex flex-col items-center text-center">
                <h1 class="text-5xl font-bold mb-8 animate__animated animate__fadeIn">
                    Powering Your Future with Solar Energy
                </h1>
                <p class="text-xl mb-12 animate__animated animate__fadeIn animate__delay-1s">
                    Transform your rooftop into a sustainable energy source
                </p>
                <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full transition animate__animated animate__fadeIn animate__delay-2s">
                    Get Started
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Box -->
    <div class="chat-container">
        <div class="bg-white rounded-lg shadow-xl p-6 chat-box">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Solar Analysis Assistant</h3>
                <button id="minimizeChat" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
            
            <div id="chatMessages" class="chat-messages mb-4">
                <!-- Messages will appear here -->
            </div>

            <div class="upload-area rounded-lg mb-4 text-center cursor-pointer" id="uploadArea">
                <input type="file" id="imageUpload" class="hidden" accept="image/*">
                <div class="text-gray-600">
                    <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p class="text-lg">Drop your rooftop image here or click to upload</p>
                </div>
            </div>

            <div class="flex space-x-2">
                <input type="text" id="messageInput" class="flex-1 border rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 text-lg" placeholder="Ask about solar potential...">
                <button id="sendMessage" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition text-lg">
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            const imageUpload = document.getElementById('imageUpload');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessage');
            const chatMessages = document.getElementById('chatMessages');

            uploadArea.addEventListener('click', () => imageUpload.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-500');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-blue-500');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-500');
                const file = e.dataTransfer.files[0];
                if (file) handleFileUpload(file);
            });

            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFileUpload(file);
            });

            function displayMessage(sender, message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `mb-4 p-3 rounded-lg ${
                    sender === 'Assistant' ? 'bg-blue-100 text-blue-800' :
                    sender === 'Error' ? 'bg-red-100 text-red-800' :
                    'bg-gray-100 text-gray-800'
                }`;

                // Check if the message is a JSON string
                try {
                    const jsonData = JSON.parse(message);
                    let formattedMessage = `<strong>${sender}:</strong><br>`;
                    
                    // Format each key-value pair
                    for (const [key, value] of Object.entries(jsonData)) {
                        // Convert key from snake_case to Title Case
                        const formattedKey = key
                            .split('_')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ');
                        
                        formattedMessage += `<strong>${formattedKey}:</strong> ${value}<br>`;
                    }
                    
                    messageDiv.innerHTML = formattedMessage;
                } catch (e) {
                    // If not JSON, display as regular message
                    messageDiv.innerHTML = `<strong>${sender}:</strong><br>${message.replace(/\n/g, '<br>')}`;
                }

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            async function handleFileUpload(file) {
                // Display the uploaded image first
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'mb-4';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'max-w-full rounded-lg shadow-lg';
                    imgDiv.appendChild(img);
                    chatMessages.appendChild(imgDiv);
                    displayMessage('You', 'Uploaded image for analysis');
                };
                reader.readAsDataURL(file);

                const formData = new FormData();
                formData.append('file', file);
                formData.append('additional_text', messageInput.value);

                try {
                    // Show loading state
                    displayMessage('System', 'Analyzing your rooftop image...');
                    
                    const response = await fetch('/analyze', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.error) {
                        displayMessage('Error', result.error);
                        return;
                    }

                    // Create a container for the analysis results
                    const analysisContainer = document.createElement('div');
                    analysisContainer.className = 'mb-4 p-4 bg-blue-50 rounded-lg';

                    // Display the analysis results
                    if (result.text_response) {
                        try {
                            const analysis = JSON.parse(result.text_response);
                            const analysisDiv = document.createElement('div');
                            analysisDiv.className = 'mb-4';
                            
                            // Create a formatted display of the analysis
                            let formattedAnalysis = '<div class="grid grid-cols-2 gap-4">';
                            for (const [key, value] of Object.entries(analysis)) {
                                const formattedKey = key
                                    .split('_')
                                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                    .join(' ');
                                formattedAnalysis += `
                                    <div class="p-2 bg-white rounded shadow">
                                        <strong class="text-blue-600">${formattedKey}:</strong>
                                        <span class="ml-2">${value}</span>
                                    </div>
                                `;
                            }
                            formattedAnalysis += '</div>';
                            
                            analysisDiv.innerHTML = formattedAnalysis;
                            analysisContainer.appendChild(analysisDiv);
                        } catch (e) {
                            // If not JSON, display as regular message
                            const textDiv = document.createElement('div');
                            textDiv.className = 'mb-4 p-3 bg-white rounded shadow';
                            textDiv.innerHTML = result.text_response.replace(/\n/g, '<br>');
                            analysisContainer.appendChild(textDiv);
                        }
                    }

                    // Display the generated image if available
                    if (result.generated_image) {
                        const imgDiv = document.createElement('div');
                        imgDiv.className = 'mt-4';
                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${result.generated_image}`;
                        img.className = 'max-w-full rounded-lg shadow-lg';
                        imgDiv.appendChild(img);
                        analysisContainer.appendChild(imgDiv);
                    }

                    // Add the entire analysis container to the chat
                    chatMessages.appendChild(analysisContainer);
                    chatMessages.scrollTop = chatMessages.scrollHeight;

                    // Clear the input
                    messageInput.value = '';
                    
                } catch (error) {
                    console.error('Error:', error);
                    displayMessage('Error', 'Failed to analyze the image. Please try again.');
                }
            }

            sendButton.addEventListener('click', () => {
                const message = messageInput.value.trim();
                if (message) {
                    displayMessage('You', message);
                    messageInput.value = '';
                }
            });

            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendButton.click();
                }
            });
        });
    </script>
</body>
</html>
